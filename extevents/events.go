// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2022 Steadybit GmbH

package extevents

import (
	"context"
	"github.com/rs/zerolog/log"
	"github.com/steadybit/action-kit/go/action_kit_api/v2"
	"github.com/steadybit/action-kit/go/action_kit_sdk"
	extension_kit "github.com/steadybit/extension-kit"
	"github.com/steadybit/extension-kit/extbuild"
	"github.com/steadybit/extension-kit/extconversion"
	"github.com/steadybit/extension-kit/extutil"
	"github.com/steadybit/extension-kubernetes/client"
	"github.com/steadybit/extension-kubernetes/extcluster"
	corev1 "k8s.io/api/core/v1"
	"os"
	"strings"
	"time"
)

const LogType = "KUBERNETES_EVENTS"

type K8sEventsAction struct {
}

type K8sEventsState struct {
	LastEventTime *int64 `json:"lastEventTime"`
	TimeoutEnd    *int64 `json:"timeoutEnd"`
}

type K8sEventsConfig struct {
	Duration int
}

func NewK8sEventsAction() action_kit_sdk.Action[K8sEventsState] {
	return K8sEventsAction{}
}

var _ action_kit_sdk.Action[K8sEventsState] = (*K8sEventsAction)(nil)
var _ action_kit_sdk.ActionWithStatus[K8sEventsState] = (*K8sEventsAction)(nil)
var _ action_kit_sdk.ActionWithStop[K8sEventsState] = (*K8sEventsAction)(nil)

func (f K8sEventsAction) NewEmptyState() K8sEventsState {
	return K8sEventsState{}
}

func (f K8sEventsAction) Describe() action_kit_api.ActionDescription {
	return action_kit_api.ActionDescription{
		Id:          "com.steadybit.extension_kubernetes.kubernetes_logs",
		Label:       "Kubernetes Event Logs",
		Description: "Collect event logs from a Kubernetes",
		Version:     extbuild.GetSemverVersionStringOrUnknown(),
		Icon:        extutil.Ptr("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTExLjk0ODEgMTMuMDY5NkwxMi41NjU3IDEyLjc3MjNMMTIuNzI1OCAxMi4xMDlMMTIuMjkxMiAxMS41NjAxSDExLjYwNTFMMTEuMTcwNSAxMi4xMDlMMTEuMzMwNiAxMi43NzIzTDExLjk0ODEgMTMuMDY5NloiIGZpbGw9IiMxRDI2MzIiLz4KPHBhdGggZD0iTTE2LjM4NTEgMTIuNzI2NUMxNi40MzA4IDEyLjI0NjIgMTYuNDA4IDExLjc2NTkgMTYuMjkzNiAxMS4yODU3QzE2LjE3OTMgMTAuODA1NCAxNS45OTYzIDEwLjM0OCAxNS43NDQ3IDkuOTM2MjdMMTQuMDI5NCAxMS40OTE1QzEzLjk4MzcgMTEuNTM3MiAxMy45NjA4IDExLjU4MyAxMy45Mzc5IDExLjY1MTZDMTMuODkyMiAxMS44NTc0IDE0LjAwNjUgMTIuMDYzMyAxNC4yMTI0IDEyLjEwOUwxNi4zODUxIDEyLjcyNjVaIiBmaWxsPSIjMUQyNjMyIi8+CjxwYXRoIGQ9Ik0xMy4xODMyIDEwLjQxNjZMMTUuMDU4NiA5LjA5MDA1QzE0LjM3MjUgOC40MDM5MyAxMy40ODA1IDcuOTY5MzggMTIuNDc0MiA3Ljg1NTAyTDEyLjYxMTQgMTAuMTY1QzEyLjYxMTQgMTAuMjMzNiAxMi42MzQzIDEwLjI3OTMgMTIuNjggMTAuMzI1MUMxMi43OTQ0IDEwLjQ4NTIgMTMuMDIzMSAxMC41MDggMTMuMTgzMiAxMC40MTY2WiIgZmlsbD0iIzFEMjYzMiIvPgo8cGF0aCBkPSJNMTEuMzc2NCA3LjgzMjE1TDEwLjkxOSA3LjkyMzY0QzEwLjExODUgOC4xMDY2IDkuMzg2NjEgOC41MTgyOCA4Ljc5MTk3IDkuMDkwMDVMMTAuNjkwMiAxMC40Mzk0QzEwLjcwNDYgMTAuNDQ0MiAxMC43MTc5IDEwLjQ0OSAxMC43MzA2IDEwLjQ1MzVDMTAuNzc5IDEwLjQ3MDkgMTAuODE4OSAxMC40ODUyIDEwLjg3MzIgMTAuNDg1MkMxMS4wNzkxIDEwLjQ4NTIgMTEuMjYyIDEwLjMyNTEgMTEuMjYyIDEwLjExOTJMMTEuMzc2NCA3LjgzMjE1WiIgZmlsbD0iIzFEMjYzMiIvPgo8cGF0aCBkPSJNOS44MjExNiAxMS40NDU4TDguMTI4NzEgOS45MzYyN0M3LjYyNTU1IDEwLjc4MjUgNy4zOTY4NCAxMS43NjU5IDcuNDY1NDUgMTIuNzI2NUw5LjY4MzkzIDEyLjA4NjFDOS43NzU0MSAxMi4wNjMzIDkuODIxMTUgMTIuMDQwNCA5Ljg2NjkgMTEuOTcxOEMxMC4wMDQxIDExLjgxMTcgOS45ODEyNSAxMS41ODMgOS44MjExNiAxMS40NDU4WiIgZmlsbD0iIzFEMjYzMiIvPgo8cGF0aCBkPSJNMTAuMDA0MSAxMy40MTI2TDcuNzM5OSAxMy44MDE1QzguMDYwMSAxNC43MTYzIDguNzAwNDggMTUuNTE2OCA5LjUwMDk2IDE2LjA0MjhMMTAuMzcwMSAxMy45Mzg3QzEwLjQxNTggMTMuODcwMSAxMC40MTU4IDEzLjc3ODYgMTAuMzkyOSAxMy43MUMxMC4zNzAxIDEzLjUyNyAxMC4xODcxIDEzLjQxMjYgMTAuMDA0MSAxMy40MTI2WiIgZmlsbD0iIzFEMjYzMiIvPgo8cGF0aCBkPSJNMTEuOTQ4MSAxNi43NTE4QzEyLjI5MTIgMTYuNzUxOCAxMi42MTE0IDE2LjcwNjEgMTIuOTMxNiAxNi42Mzc0QzEzLjA5MTcgMTYuNTkxNyAxMy4yMjg5IDE2LjU2ODggMTMuMzY2MSAxNi41NDZMMTIuMjY4MyAxNC41NTYyQzEyLjE5OTcgMTQuNDg3NiAxMi4xNTQgMTQuNDQxOCAxMi4wODU0IDE0LjM5NjFDMTEuOTI1MyAxNC4zMDQ2IDExLjc0MjMgMTQuMzUwNCAxMS42MjggMTQuNDg3NkwxMC41MDczIDE2LjUyMzFDMTAuOTY0NyAxNi42NjAzIDExLjQ2NzkgMTYuNzUxOCAxMS45NDgxIDE2Ljc1MThaIiBmaWxsPSIjMUQyNjMyIi8+CjxwYXRoIGQ9Ik0xNC4zNDk2IDE2LjAxOTlDMTQuODk4NSAxNS42NzY5IDE1LjM3ODggMTUuMTk2NiAxNS43MjE4IDE0LjY0NzdDMTUuOTA0OCAxNC4zOTYxIDE2LjA0MiAxNC4wOTg4IDE2LjE1NjQgMTMuNzc4NkwxMy44NjkzIDEzLjM4OThDMTMuODAwNyAxMy4zODk4IDEzLjczMjEgMTMuNDEyNiAxMy42NjM1IDEzLjQzNTVDMTMuNTAzNCAxMy41MDQxIDEzLjQxMTkgMTMuNjg3MSAxMy40NTc2IDEzLjg3MDFMMTQuMzQ5NiAxNi4wMTk5WiIgZmlsbD0iIzFEMjYzMiIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE5LjUxODUgNS40NTM1QzE5Ljg2MTYgNS42MzY0NyAyMC4xMzYgNS45MzM3OSAyMC4yNTA0IDYuMjk5NzNMMjEuOTg4NiAxMy43Nzg1QzIyLjAzNDMgMTQuMTY3MyAyMS45NDI4IDE0LjU1NjEgMjEuNzE0MSAxNC44NzYzTDE2Ljg4ODQgMjAuODQ1NkMxNi42MzY4IDIxLjE4ODcgMTYuMjQ4IDIxLjM3MTYgMTUuODM2MyAyMS4zMjU5SDguMTUxNjhDNy43NjI4OCAyMS4zMDMgNy4zNzQwNyAyMS4xMjAxIDcuMDk5NjIgMjAuODQ1NkwyLjI3Mzg2IDE0Ljg3NjNDMi4wNDUxNiAxNC41NTYxIDEuOTUzNjcgMTQuMTY3MyAyLjAyMjI4IDEzLjc3ODVMMy43Mzc2IDYuMjUzOThDMy44MjkwOCA1Ljg2NTE4IDQuMDgwNjYgNS41Njc4NiA0LjQyMzczIDUuNDA3NzZMMTEuMzk5MyAyLjA0NTc0QzExLjU4MjMgMiAxMS43ODgyIDIgMTEuOTcxMSAyQzEyLjE1NDEgMiAxMi4zNTk5IDIuMDIyODcgMTIuNTQyOSAyLjExNDM1TDE5LjUxODUgNS40NTM1Wk0xOS4xMjk2IDEzLjQ1ODRDMTkuMTI5NiAxMy40ODEzIDE5LjE1MjUgMTMuNDgxMyAxOS4xNzUzIDEzLjQ4MTNDMTkuMzgxMiAxMy41MjcgMTkuNTY0MiAxMy43MSAxOS41ODcgMTMuOTYxNUMxOS41MTg0IDE0LjE0NDUgMTkuMzM1NCAxNC4yODE3IDE5LjEyOTYgMTQuMjgxN0MxOS4wODM5IDE0LjI4MTcgMTkuMDYxIDE0LjI4MTcgMTkuMDE1MyAxNC4yNTg5QzE4Ljk5MjQgMTQuMjM2IDE4Ljk5MjQgMTQuMjM2IDE4Ljk2OTUgMTQuMjM2QzE4Ljk0MjcgMTQuMjM2IDE4LjkyMzggMTQuMjI4MiAxOC45MDgxIDE0LjIyMTdDMTguODk3IDE0LjIxNzEgMTguODg3NSAxNC4yMTMxIDE4Ljg3OCAxNC4yMTMxQzE4LjgxMDIgMTQuMTk2MiAxOC43NTQ5IDE0LjE2NjYgMTguNjkzNiAxNC4xMzM4QzE4LjY3MjIgMTQuMTIyNCAxOC42NTAxIDE0LjExMDYgMTguNjI2NCAxNC4wOTg4QzE4LjU4MDcgMTQuMDk4OCAxOC41MzUgMTQuMDc1OSAxOC40ODkyIDE0LjA1M0gxOC40NjY0QzE4LjIzNzYgMTMuOTYxNSAxNy45ODYxIDEzLjg5MjkgMTcuNzM0NSAxMy44NDcySDE3LjcxMTZDMTcuNjQzIDEzLjg0NzIgMTcuNTc0NCAxMy44NzAxIDE3LjUyODYgMTMuOTE1OEMxNy41Mjg2IDEzLjkxNTggMTcuNTI4NiAxMy45Mzg3IDE3LjUwNTggMTMuOTM4N0wxNy4zMjI4IDEzLjkxNThDMTYuOTExMSAxNS4yMTk0IDE2LjAxOTIgMTYuMzE3MyAxNC44NTI4IDE3LjAyNjJMMTQuOTIxNCAxNy4yMDkyQzE0LjkyMTQgMTcuMjA5MiAxNC44OTg1IDE3LjIwOTIgMTQuODk4NSAxNy4yMzIxQzE0Ljg1MjcgMTcuMzAwNyAxNC44NTI3IDE3LjM5MjIgMTQuODc1NiAxNy40NjA4QzE0Ljk2NzEgMTcuNjg5NSAxNS4wODE1IDE3LjkxODIgMTUuMjQxNiAxOC4xMjQxVjE4LjE2OThDMTUuMjg3MyAxOC4yMTU1IDE1LjMxMDIgMTguMjM4NCAxNS4zMzMgMTguMjg0MUMxNS40MDE3IDE4LjM1MjggMTUuNDQ3NCAxOC40MjE0IDE1LjQ5MzEgMTguNTEyOUMxNS41MTYgMTguNTM1NyAxNS41Mzg5IDE4LjU1ODYgMTUuNTM4OSAxOC41ODE1QzE1LjUzODkgMTguNTgxNSAxNS41NjE3IDE4LjU4MTUgMTUuNTYxNyAxOC42MDQzQzE1LjYwNzUgMTguNzE4NyAxNS42MDc1IDE4LjgzMyAxNS41ODQ2IDE4Ljk0NzRDMTUuNTYxNyAxOS4wNjE4IDE1LjQ3MDMgMTkuMTUzMiAxNS4zNzg4IDE5LjE5OUMxNS4zNjQ1IDE5LjIwMzggMTUuMzUxMSAxOS4yMDg1IDE1LjMzODQgMTkuMjEzMUMxNS4yOTAxIDE5LjIzMDQgMTUuMjUwMSAxOS4yNDQ3IDE1LjE5NTggMTkuMjQ0N0MxNS4wMTI4IDE5LjI0NDcgMTQuODUyNyAxOS4xMzA0IDE0Ljc2MTMgMTguOTcwM0MxNC43Mzg0IDE4Ljk3MDMgMTQuNzM4NCAxOC45NDc0IDE0LjczODQgMTguOTQ3NEMxNC43MjcgMTguOTM2IDE0LjcyMTIgMTguOTI0NSAxNC43MTU1IDE4LjkxMzFDMTQuNzA5OCAxOC45MDE3IDE0LjcwNDEgMTguODkwMiAxNC42OTI3IDE4Ljg3ODhDMTQuNjQ2OSAxOC44MTAyIDE0LjYyNCAxOC43MTg3IDE0LjYwMTIgMTguNjI3MkwxNC41NTU0IDE4LjQ5VjE4LjQ2NzFDMTQuNDg2OCAxOC4yMTU1IDE0LjM3MjUgMTcuOTg2OCAxNC4yNTgxIDE3Ljc1ODFDMTQuMjEyNCAxNy42ODk1IDE0LjE0MzggMTcuNjQzOCAxNC4wNzUxIDE3LjYyMDlDMTQuMDc1MSAxNy41OTggMTQuMDc1MSAxNy41OTggMTQuMDUyMyAxNy41OThMMTMuOTYwOCAxNy40Mzc5QzEzLjkwMjYgMTcuNDU1NCAxMy44NDI5IDE3LjQ3NDMgMTMuNzgyMSAxNy40OTM2QzEzLjYwNCAxNy41NTAxIDEzLjQxNjUgMTcuNjA5NyAxMy4yMjg5IDE3LjY0MzhDMTIuODE3MiAxNy43NTgxIDEyLjQwNTYgMTcuODAzOSAxMS45OTM5IDE3LjgwMzlDMTEuMzA3OCAxNy44MDM5IDEwLjY0NDUgMTcuNjg5NSAxMC4wMDQxIDE3LjQzNzlMOS45MTI2NCAxNy42MjA5QzkuOTEyNjQgMTcuNjMyMyA5LjkxMjY0IDE3LjYzOCA5LjkwOTc4IDE3LjY0MDlDOS45MDY5MiAxNy42NDM4IDkuOTAxMiAxNy42NDM4IDkuODg5NzcgMTcuNjQzOEM5LjgyMTE2IDE3LjY2NjYgOS43NTI1NCAxNy43MTI0IDkuNzA2OCAxNy43ODFDOS41OTI0NSAxOC4wMDk3IDkuNDc4MDkgMTguMjM4NCA5LjQwOTQ4IDE4LjQ5TDkuMzYzNzQgMTguNjI3MkM5LjM1MjMgMTguNjczIDkuMzM1MTUgMTguNzEzIDkuMzE4IDE4Ljc1M0M5LjMwMDg0IDE4Ljc5MyA5LjI4MzY5IDE4LjgzMyA5LjI3MjI1IDE4Ljg3ODhDOS4yNDkzOCAxOC45MDE3IDkuMjI2NTEgMTguOTI0NSA5LjIyNjUxIDE4Ljk0NzRDOS4yMDM2NCAxOC45NDc0IDkuMjAzNjQgMTguOTcwMyA5LjIwMzY0IDE4Ljk3MDNDOS4xMTIxNiAxOS4xMzA0IDguOTUyMDYgMTkuMjQ0NyA4Ljc2OTA5IDE5LjI0NDdDOC43MjMzNSAxOS4yNDQ3IDguNjU0NzQgMTkuMjIxOSA4LjYwOSAxOS4xOTlDOC40MDMxNiAxOS4wODQ2IDguMzExNjggMTguODEwMiA4LjQyNjAzIDE4LjU4MTVDOC40NDg5IDE4LjU4MTUgOC40NDg5IDE4LjU1ODYgOC40NDg5IDE4LjU1ODZDOC40NjAzNCAxOC41NDcyIDguNDY2MDUgMTguNTM1NyA4LjQ3MTc3IDE4LjUyNDNDOC40Nzc0OSAxOC41MTI5IDguNDgzMjEgMTguNTAxNCA4LjQ5NDY0IDE4LjQ5QzguNTI0NzMgMTguNDQ5OSA4LjU1MDQxIDE4LjQwOTggOC41NzM2MyAxOC4zNzM1QzguNjAzMzcgMTguMzI3MSA4LjYyOTA1IDE4LjI4NyA4LjY1NDc0IDE4LjI2MTNDOC43MDA0OCAxOC4yMTU1IDguNzIzMzUgMTguMTkyNyA4Ljc0NjIyIDE4LjE0NjlWMTguMTI0MUM4Ljg4MzQ1IDE3LjkxODIgOS4wMjA2NyAxNy42ODk1IDkuMTEyMTYgMTcuNDYwOEM5LjEzNTAzIDE3LjM5MjIgOS4xMzUwMyAxNy4zMDA3IDkuMDg5MjkgMTcuMjMyMUM5LjA4OTI5IDE3LjIzMjEgOS4wNjY0MiAxNy4yMzIxIDkuMDY2NDIgMTcuMjA5Mkw5LjE4MDc3IDE3LjA0OTFDOC45NTIwNiAxNi45MzQ4IDguNzY5MDkgMTYuNzk3NSA4LjU2MzI2IDE2LjYzNzRDNy42NzEyOSAxNS45NTEzIDcuMDMwOTEgMTUuMDEzNiA2LjY4Nzg0IDEzLjk2MTVMNi40ODIwMSAxMy45ODQ0QzYuNDgyMDEgMTMuOTg0NCA2LjQ4MjAxIDEzLjk2MTUgNi40NTkxNCAxMy45NjE1QzYuNDEzMzkgMTMuOTE1OCA2LjM0NDc4IDEzLjg5MjkgNi4yNzYxNyAxMy44OTI5SDYuMjUzM0M1Ljk3ODg1IDEzLjkzODcgNS43NTAxNCAxNC4wMDczIDUuNDk4NTYgMTQuMDk4OEg1LjQ3NTY5QzUuNDI5OTQgMTQuMDk4OCA1LjM4NDIgMTQuMTIxNiA1LjMzODQ2IDE0LjE0NDVDNS4zMTI5MiAxNC4xNTMgNS4yODQyIDE0LjE2NDcgNS4yNTM1IDE0LjE3NzJDNS4yMDE3MyAxNC4xOTgzIDUuMTQ0MzEgMTQuMjIxNiA1LjA4Njg4IDE0LjIzNkM1LjA3OTk2IDE0LjIzNiA1LjA2ODg0IDE0LjIzMzkgNS4wNTY3IDE0LjIzMTZDNS4wMjg3NSAxNC4yMjYzIDQuOTk1NCAxNC4yMjAxIDQuOTk1NCAxNC4yMzZDNC45OTU0IDE0LjI0NzQgNC45OTU0IDE0LjI1MzIgNC45OTI1NCAxNC4yNTZDNC45ODk2OCAxNC4yNTg5IDQuOTgzOTYgMTQuMjU4OSA0Ljk3MjUzIDE0LjI1ODlDNC45MjY3OSAxNC4yODE3IDQuOTAzOTEgMTQuMjgxNyA0Ljg1ODE3IDE0LjI4MTdDNC42NTIzMyAxNC4zMDQ2IDQuNDQ2NSAxNC4xNjc0IDQuNDAwNzUgMTMuOTYxNUM0LjM1NTAxIDEzLjcxIDQuNTE1MTEgMTMuNDgxMyA0Ljc2NjY5IDEzLjQzNTVDNC43Nzk4NCAxMy40MjI0IDQuNzg1NDMgMTMuNDE2OCA0Ljc5MjE1IDEzLjQxNDRDNC43OTcxMiAxMy40MTI2IDQuODAyNzEgMTMuNDEyNiA0LjgxMjQzIDEzLjQxMjZDNC44MzkyMyAxMy40MTI2IDQuODU4MTcgMTMuNDA0OCA0Ljg3Mzg3IDEzLjM5ODNDNC44ODQ5NyAxMy4zOTM3IDQuODk0NDQgMTMuMzg5OCA0LjkwMzkxIDEzLjM4OThDNC45NDk2NiAxMy4zODk4IDQuOTk1NCAxMy4zODQxIDUuMDQxMTQgMTMuMzc4M0M1LjA4Njg4IDEzLjM3MjYgNS4xMzI2MiAxMy4zNjY5IDUuMTc4MzcgMTMuMzY2OUM1LjIyNDExIDEzLjM0NCA1LjI2OTg1IDEzLjM0NCA1LjMxNTU5IDEzLjM0NEM1LjU5MDA0IDEzLjMyMTIgNS44NDE2MiAxMy4yNzU0IDYuMDkzMiAxMy4yMDY4QzYuMTYxODEgMTMuMTYxMSA2LjIzMDQzIDEzLjExNTMgNi4yNTMzIDEzLjA0NjdDNi4yNTMzIDEzLjA0NjcgNi4yNzYxNyAxMy4wNDY3IDYuMjc2MTcgMTMuMDIzOEw2LjQ1OTE0IDEyLjk3ODFDNi4yNTMzIDExLjY3NDUgNi41NTA2MiAxMC4zNDggNy4yNTk2MiA5LjIyNzI4QzcuMjcxMDUgOS4yMDQ0MSA3LjI4MjQ5IDkuMTg3MjUgNy4yOTM5MiA5LjE3MDFDNy4zMDUzNiA5LjE1Mjk1IDcuMzE2NzkgOS4xMzU3OSA3LjMyODIzIDkuMTEyOTJMNy4xOTU0NiA4Ljk4MDE2QzcuMjA1OSA4LjkxNDM2IDcuMTY0MTUgOC44MzQ0OSA3LjEyMjM5IDguNzkyNzNDNi45Mzk0MiA4LjYwOTc2IDYuNzEwNzEgOC40NzI1NCA2LjQ4MjAxIDguMzM1MzFMNi4zNDQ3OCA4LjI2NjdDNi4yNTMzIDguMjIwOTYgNi4xNjE4MSA4LjE3NTIyIDYuMDkzMiA4LjEyOTQ3QzYuMDcwMzMgOC4xMjk0NyA2LjAyNDU5IDguMDgzNzMgNi4wMjQ1OSA4LjA4MzczQzYuMDI0NTkgOC4wODM3MyA2LjAyNDU5IDguMDYwODYgNi4wMDE3MiA4LjA2MDg2QzUuODE4NzUgNy45MDA3NyA1Ljc3MzAxIDcuNjI2MzIgNS45MTAyMyA3LjQyMDQ4QzUuOTc4ODUgNy4zMDYxMiA2LjA5MzIgNy4yNjAzOCA2LjIzMDQzIDcuMjYwMzhDNi4zNDQ3OCA3LjI2MDM4IDYuNDU5MTQgNy4zMDYxMiA2LjU1MDYyIDcuMzc0NzRMNi41NzM0OSA3LjM5NzYxQzYuNTg0OTIgNy40MDkwNCA2LjU5NjM2IDcuNDE0NzYgNi42MDc4IDcuNDIwNDhDNi42MTkyMyA3LjQyNjIgNi42MzA2NyA3LjQzMTkxIDYuNjQyMSA3LjQ0MzM1QzYuNjc2NDEgNy40Nzc2NSA2LjcwNSA3LjUxMTk2IDYuNzMzNTggNy41NDYyN0M2Ljc2MjE3IDcuNTgwNTcgNi43OTA3NiA3LjYxNDg4IDYuODI1MDcgNy42NDkxOUM2LjgzMTk5IDcuNjU2MTEgNi44NDEwMiA3LjY2MzA0IDYuODUwODYgNy42NzA2QzYuODczNTQgNy42ODggNi45MDA2MSA3LjcwODc4IDYuOTE2NTUgNy43NDA2N0M3LjA3NjY1IDcuOTIzNjQgNy4yODI0OSA4LjEwNjYgNy40ODgzMiA4LjI2NjdDNy41MzQwNyA4LjI4OTU3IDcuNTc5ODEgOC4zMTI0NCA3LjYyNTU1IDguMzEyNDRDNy42NTIzNSA4LjMxMjQ0IDcuNjcxMjkgOC4zMDQ1OSA3LjY4Njk5IDguMjk4MDlDNy42OTgwOSA4LjI5MzQ5IDcuNzA3NTYgOC4yODk1NyA3LjcxNzAzIDguMjg5NTdINy43Mzk5TDcuODc3MTMgOC4zODEwNUM4LjYzMTg3IDcuNTgwNTcgOS42MTUzMiA3LjAwODggMTAuNjkwMiA2Ljc4MDA5QzEwLjcyOTkgNi43NzM0OSAxMC43NjkgNi43NjY4OSAxMC44MDc3IDYuNzYwMzVDMTEuMDM3MyA2LjcyMTYyIDExLjI1MjYgNi42ODUzMSAxMS40Njc5IDYuNjY1NzRMMTEuNDkwNyA2LjQ4Mjc3VjYuNDM3MDNDMTEuNTU5MyA2LjM5MTI5IDExLjU4MjIgNi4zMjI2OCAxMS42MDUxIDYuMjU0MDZDMTEuNjA1MSA1Ljk3OTYxIDExLjYwNTEgNS43MjgwMyAxMS41NTkzIDUuNDc2NDVWNS40NTM1OEMxMS41NTkzIDUuNDA3ODQgMTEuNTU5MyA1LjM2MjEgMTEuNTM2NSA1LjMxNjM2QzExLjUxMzYgNS4yMjQ4NyAxMS40OTA3IDUuMTMzMzkgMTEuNDkwNyA1LjA0MTkxVjQuOTI3NTVDMTEuNDkwNyA0LjgxMzIgMTEuNTM2NSA0LjY5ODg0IDExLjYyOCA0LjYwNzM2QzExLjc0MjMgNC40OTMgMTEuODc5NSA0LjQyNDM5IDEyLjAxNjggNC40NDcyNkMxMi4yNDU1IDQuNDcwMTMgMTIuNDI4NCA0LjY5ODg0IDEyLjQwNTYgNC45Mjc1NVY1LjA2NDc4QzEyLjM5NDEgNS4xMTA1MiAxMi4zODg0IDUuMTU2MjYgMTIuMzgyNyA1LjIwMkMxMi4zNzcgNS4yNDc3NCAxMi4zNzEzIDUuMjkzNDkgMTIuMzU5OCA1LjMzOTIzQzEyLjM1OTggNS4zNjIxIDEyLjM1NDEgNS4zODQ5NyAxMi4zNDg0IDUuNDA3ODRDMTIuMzQyNyA1LjQzMDcxIDEyLjMzNyA1LjQ1MzU4IDEyLjMzNyA1LjQ3NjQ1VjUuNDk5MzJDMTIuMjkxMiA1Ljc3Mzc3IDEyLjI5MTIgNi4wMjUzNSAxMi4yOTEyIDYuMjc2OTNDMTIuMzE0MSA2LjM0NTU1IDEyLjMzNyA2LjQxNDE2IDEyLjQwNTYgNi40NTk5VjYuNDM3MDNMMTIuNDI4NCA2LjYyQzEzLjUwMzQgNi43MzQzNSAxNC41NTU0IDcuMTQ2MDMgMTUuNDAxNyA3LjgwOTI4QzE1LjQ5MzEgNy45MDA3NyAxNS41OTAzIDcuOTkyMjUgMTUuNjg3NSA4LjA4MzczQzE1Ljc4NDcgOC4xNzUyMiAxNS44ODE5IDguMjY2NyAxNS45NzM0IDguMzU4MThMMTYuMTU2NCA4LjI0MzgzSDE2LjE3OTNDMTYuMjAyMSA4LjI2NjcgMTYuMjQ3OSA4LjI2NjcgMTYuMjcwNyA4LjI2NjdDMTYuMzE2NSA4LjI2NjcgMTYuMzYyMiA4LjI0MzgzIDE2LjQwOCA4LjIyMDk2QzE2LjYxMzggOC4wODM3MyAxNi44MTk2IDcuOTAwNzcgMTYuOTc5NyA3LjcxNzhDMTYuOTg2NyA3LjcxMDg3IDE2Ljk5NTcgNy43MDM5NSAxNy4wMDU1IDcuNjk2MzlDMTcuMDI4MiA3LjY3ODk4IDE3LjA1NTMgNy42NTgyMSAxNy4wNzEyIDcuNjI2MzJDMTcuMTE3IDcuNTU3NzEgMTcuMTg1NiA3LjQ4OTEgMTcuMjU0MiA3LjQyMDQ5QzE3LjI3NzEgNy40MjA0OSAxNy4yOTk5IDcuMzk3NjEgMTcuMzIyOCA3LjM3NDc0TDE3LjM0NTcgNy4zNTE4NkMxNy40MzcyIDcuMjgzMjUgMTcuNTUxNSA3LjIzNzUxIDE3LjY2NTkgNy4yMzc1MUMxNy43ODAyIDcuMjM3NTEgMTcuOTE3NCA3LjMwNjEyIDE3Ljk4NjEgNy4zOTc2MUMxOC4xNDYyIDcuNjAzNDQgMTguMTAwNCA3Ljg3Nzg5IDE3Ljg5NDYgOC4wMzc5OUMxNy44OTQ2IDguMDQ2NzMgMTcuODk3OSA4LjA1MjEzIDE3LjkwMDggOC4wNTY3NEMxNy45MDU0IDguMDY0MiAxNy45MDg3IDguMDY5NiAxNy44OTQ2IDguMDgzNzNDMTcuODgzMSA4LjA5NTE3IDE3Ljg3MTcgOC4xMDA4OSAxNy44NjAzIDguMTA2NkMxNy44NDg4IDguMTEyMzIgMTcuODM3NCA4LjExODA0IDE3LjgyNiA4LjEyOTQ3QzE3Ljc4MDIgOC4xNTIzNSAxNy43NDAyIDguMTc1MjIgMTcuNzAwMiA4LjE5ODA5QzE3LjY2MDEgOC4yMjA5NiAxNy42MjAxIDguMjQzODMgMTcuNTc0NCA4LjI2NjdMMTcuNDM3MiA4LjMzNTMxQzE3LjIwODUgOC40NzI1NCAxNy4wMDI2IDguNjA5NzYgMTYuNzk2OCA4Ljc5MjczQzE2Ljc1MSA4LjgzODQ3IDE2LjcyODIgOC45Mjk5NiAxNi43MjgyIDguOTk4NTdWOS4wMjE0NEwxNi41OTA5IDkuMTU4NjZDMTYuOTU2OSA5LjczMDQ0IDE3LjIzMTMgMTAuMzcwOCAxNy4zOTE0IDExLjAzNDFDMTcuNTI4NiAxMS42OTczIDE3LjU3NDQgMTIuMzgzNSAxNy40ODI5IDEzLjA0NjdMMTcuNjY1OSAxMy4wOTI1QzE3LjY4ODcgMTMuMTYxMSAxNy43NTc0IDEzLjIyOTcgMTcuODI2IDEzLjI1MjZDMTguMDc3NSAxMy4zMjEyIDE4LjM1MiAxMy4zNjY5IDE4LjYwMzYgMTMuMzg5OEgxOC42MjY0QzE4LjY3MjIgMTMuNDEyNiAxOC43MTc5IDEzLjQxMjYgMTguNzYzNyAxMy40MTI2QzE4Ljg1NTIgMTMuNDEyNiAxOC45NDY2IDEzLjQxMjYgMTkuMDM4MSAxMy40MzU1QzE5LjA4MzkgMTMuNDM1NSAxOS4xMjk2IDEzLjQzNTUgMTkuMTI5NiAxMy40NTg0Wk03LjE5NTQ2IDguOTgwMTZMNy4xOTEgOC45NzU3VjguOTk4NTdDNy4xOTMgOC45OTI1OSA3LjE5NDQ3IDguOTg2NDQgNy4xOTU0NiA4Ljk4MDE2WiIgZmlsbD0iIzFEMjYzMiIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI2IiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTEuNTA0OSAxMC4xNjI5QzExLjQzNTYgOS45OTkzNCAxMS4yNTkzIDkuOTAyMDYgMTEuMDc1NyA5LjkwMDAzQzEwLjg5MjEgOS44OTgwMSAxMC43MTMzIDkuOTkxMjkgMTAuNjM5MiAxMC4xNTI2TDkuNTcxMzQgMTIuNDc2N0g4LjM2MzY0QzguMTI1NyAxMi40NzY3IDcuOSAxMi42NDAzIDcuOSAxMi44Nzg5QzcuOSAxMy4xMTc2IDguMTI1NyAxMy4yODExIDguMzYzNjQgMTMuMjgxMUg5Ljg4NTg0QzEwLjA2NzQgMTMuMjgxMSAxMC4yNDMxIDEzLjE4OCAxMC4zMTY0IDEzLjAyODVMMTEuMDUyIDExLjQyNzVMMTIuNDk1MSAxNC44MzdDMTIuNTYwNSAxNC45OTE0IDEyLjcyMTkgMTUuMDg3NSAxMi44OTUxIDE1LjA5ODhDMTMuMDY4MiAxNS4xMTAyIDEzLjI0MjUgMTUuMDM2NiAxMy4zMzM5IDE0Ljg5NjFMMTQuMzg1MSAxMy4yODExSDE1LjYzNjRDMTUuODc0MyAxMy4yODExIDE2LjEgMTMuMTE3NiAxNi4xIDEyLjg3ODlDMTYuMSAxMi42NDAzIDE1Ljg3NDMgMTIuNDc2NyAxNS42MzY0IDEyLjQ3NjdIMTQuMTE0MkMxMy45NTI2IDEyLjQ3NjcgMTMuNzk1NSAxMi41NTAxIDEzLjcxMDUgMTIuNjgwNkwxMy4wMTk3IDEzLjc0MTlMMTEuNTA0OSAxMC4xNjI5WiIgZmlsbD0iIzFEMjYzMiIgc3Ryb2tlPSIjMUQyNjMyIiBzdHJva2Utd2lkdGg9IjAuMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo="),
		Category:    extutil.Ptr("Kubernetes"),
		TimeControl: action_kit_api.TimeControlInternal,
		Kind:        action_kit_api.Other,
		TargetSelection: extutil.Ptr(action_kit_api.TargetSelection{
			TargetType:          extcluster.ClusterTargetType,
			QuantityRestriction: extutil.Ptr(action_kit_api.ExactlyOne),
			SelectionTemplates: extutil.Ptr([]action_kit_api.TargetSelectionTemplate{
				{
					Label:       "default",
					Description: extutil.Ptr("Find cluster by name"),
					Query:       "k8s.cluster-name=\"\"",
				},
			}),
		}),
		Parameters: []action_kit_api.ActionParameter{
			{
				Name:         "duration",
				Label:        "Duration",
				Description:  extutil.Ptr(""),
				Type:         action_kit_api.Duration,
				DefaultValue: extutil.Ptr("60s"),
				Order:        extutil.Ptr(1),
				Required:     extutil.Ptr(true),
			},
		},
		Widgets: extutil.Ptr([]action_kit_api.Widget{
			action_kit_api.LogWidget{
				Type:    action_kit_api.ComSteadybitWidgetLog,
				Title:   "Kubernetes Events",
				LogType: LogType,
			},
		}),
		Prepare: action_kit_api.MutatingEndpointReference{},
		Start:   action_kit_api.MutatingEndpointReference{},
		Status:  extutil.Ptr(action_kit_api.MutatingEndpointReferenceWithCallInterval{}),
		Stop:    extutil.Ptr(action_kit_api.MutatingEndpointReference{}),
	}
}

func (f K8sEventsAction) Prepare(_ context.Context, state *K8sEventsState, request action_kit_api.PrepareActionRequestBody) (*action_kit_api.PrepareResult, error) {
	var config K8sEventsConfig
	if err := extconversion.Convert(request.Config, &config); err != nil {
		return nil, extension_kit.ToError("Failed to unmarshal the config.", err)
	}

	var timeoutEnd *int64
	if config.Duration != 0 {
		timeoutEnd = extutil.Ptr(time.Now().Add(time.Duration(int(time.Millisecond) * config.Duration)).Unix())
	}
	state.LastEventTime = extutil.Ptr(time.Now().Unix())
	state.TimeoutEnd = timeoutEnd
	return nil, nil
}

func (f K8sEventsAction) Start(_ context.Context, state *K8sEventsState) (*action_kit_api.StartResult, error) {
	state.LastEventTime = extutil.Ptr(time.Now().Unix())
	return nil, nil
}

func (f K8sEventsAction) Status(_ context.Context, state *K8sEventsState) (*action_kit_api.StatusResult, error) {
	return statusInternal(client.K8S, state), nil
}

func statusInternal(k8s *client.Client, state *K8sEventsState) *action_kit_api.StatusResult {
	if state.TimeoutEnd != nil && time.Now().After(time.Unix(*state.TimeoutEnd, 0)) {
		return extutil.Ptr(action_kit_api.StatusResult{
			Completed: true,
		})
	}

	messages := getMessages(k8s, state)
	return extutil.Ptr(action_kit_api.StatusResult{
		Completed: false,
		Messages:  messages,
	})
}

func getMessages(k8s *client.Client, state *K8sEventsState) *action_kit_api.Messages {
	newLastEventTime := time.Now().Unix()
	events := k8s.Events(time.Unix(*state.LastEventTime, 0))
	state.LastEventTime = extutil.Ptr(newLastEventTime)

	// log events
	for _, event := range *events {
		log.Debug().Msgf("Event: %s", event.Message)
	}

	messages := eventsToMessages(events)
	return messages
}

func (f K8sEventsAction) Stop(_ context.Context, state *K8sEventsState) (*action_kit_api.StopResult, error) {
	return stopInternal(client.K8S, state), nil
}

func stopInternal(k8s *client.Client, state *K8sEventsState) *action_kit_api.StopResult {
	messages := getMessages(k8s, state)
	return extutil.Ptr(action_kit_api.StopResult{
		Messages: messages,
	})
}

func eventsToMessages(events *[]corev1.Event) *action_kit_api.Messages {
	var messages []action_kit_api.Message
	clusterName, cnAvailable := os.LookupEnv("STEADYBIT_EXTENSION_CLUSTER_NAME")
	if !cnAvailable {
		clusterName = "unknown"
	}
	for _, event := range *events {
		messages = append(messages, action_kit_api.Message{
			Message:         event.Message,
			Type:            extutil.Ptr(LogType),
			Level:           convertToLevel(event.Type),
			Timestamp:       extutil.Ptr(event.LastTimestamp.Time),
			TimestampSource: extutil.Ptr(action_kit_api.TimestampSourceExternal),
			Fields: extutil.Ptr(action_kit_api.MessageFields{
				"reason":       event.Reason,
				"cluster-name": clusterName,
				"namespace":    event.Namespace,
				"object":       strings.ToLower(event.InvolvedObject.Kind) + "/" + event.InvolvedObject.Name,
			}),
		})
	}
	return extutil.Ptr(messages)
}

func convertToLevel(eventType string) *action_kit_api.MessageLevel {
	switch eventType {
	case "Error":
		return extutil.Ptr(action_kit_api.Error)
	case "Debug":
		return extutil.Ptr(action_kit_api.Debug)
	case "Normal":
		return extutil.Ptr(action_kit_api.Info)
	case "Warning":
		return extutil.Ptr(action_kit_api.Warn)
	default:
		return extutil.Ptr(action_kit_api.Info)
	}
}
